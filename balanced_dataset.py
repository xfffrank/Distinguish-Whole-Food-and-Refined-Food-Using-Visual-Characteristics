# -*- coding: utf-8 -*-
"""balanced_dataset.ipynb

Automatically generated by Colaboratory.
"""

'''
Dataset link: https://mmspg.epfl.ch/downloads/food-image-datasets/

Apply oversampling and undersampling for whole/refined food dataset.
'''

from google.colab import drive
drive.mount('/content/drive')

import shutil
import os
import random

#! unzip "drive/My Drive/MSc dataset/Food-11.zip" -d "drive/My Drive/MSc dataset/food11-balanced-undersample"
#! unzip "drive/My Drive/MSc dataset/Food-11.zip" -d "drive/My Drive/MSc dataset/food11"


def preprocess_dataset(dir_path):
    # create directories if not exist
    try:
        os.mkdir(dir_path + '/whole food')
        os.mkdir(dir_path + '/refined food')
    except:
        print('The directory already exists !')
    else:
        print('Directories created !')
    # process
    num_of_refined = 0
    num_of_whole = 0
    
    files = os.listdir(dir_path)
    random.seed(0)
    random.shuffle(files)
    
    # images of whole food > images of refined food
    # Down-sampling the dataset of whole food
    
    for f in files:
        img_path = os.path.join(dir_path, f)
        if (not os.path.isdir(img_path) and img_path.endswith('jpg')):
            if (f[0] not in ['3', '5', '8', '9'] and f[:2] != '10'):
                new_path = os.path.join(dir_path + "/refined food", f)
                shutil.move(img_path, new_path)
                num_of_refined += 1
                
    for f in files:
        img_path = os.path.join(dir_path, f)
        if (not os.path.isdir(img_path) and img_path.endswith('jpg')):
            if (f[0] in ['3', '5', '8', '9'] or f[:2] == '10'):
                new_path = os.path.join(dir_path + "/whole food", f)
                shutil.move(img_path, new_path)
                num_of_whole += 1
                if num_of_whole == num_of_refined:
                    break
    
    assert num_of_whole == num_of_refined
    print('The number of training set per class:', num_of_whole)
    print(f'preprocess_dataset "{dir_path}" done!')


def oversampling(dir_path):
    '''Based on the result of "preprocess_dataset" function.'''
    files = os.listdir(dir_path)
    num_of_whole = 0
    
    # Move the remaining whole food images.
    for f in files:
        img_path = os.path.join(dir_path, f)
        if (not os.path.isdir(img_path) and img_path.endswith('jpg')):
            if (f[0] in ['3', '5', '8', '9'] or f[:2] == '10'):
                new_path = os.path.join(dir_path + "/whole food", f)
                shutil.move(img_path, new_path)
                num_of_whole += 1
    print('The number of images to be resampled:', num_of_whole)
    
    # Oversample the refined food images.
    refined_dir = dir_path + '/refined food'
    files = os.listdir(refined_dir)
    random.seed(0)
    random.shuffle(files)
    
    num_of_oversampling = 0
    for f in files:
        img_path = os.path.join(refined_dir, f)
        if (not os.path.isdir(img_path) and img_path.endswith('jpg')):
            copied_img = img_path[:-4] + '_copy' + '.jpg'
            shutil.copyfile(img_path, copied_img)
            num_of_oversampling += 1
            if num_of_oversampling == num_of_whole:
                break
                
    # validation
    whole_dir = dir_path + '/whole food'
    assert len(os.listdir(whole_dir)) == len(os.listdir(refined_dir))



train_path = "drive/My Drive/MSc dataset/food11-balanced-undersample/training"
eval_path = "drive/My Drive/MSc dataset/food11-balanced-undersample/validation"
test_path = "drive/My Drive/MSc dataset/food11-balanced-undersample/evaluation"

preprocess_dataset(train_path)
preprocess_dataset(eval_path)
preprocess_dataset(test_path)

# oversampling(train_path)
# oversampling(eval_path)
# oversampling(test_path)